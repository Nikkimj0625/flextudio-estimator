<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>플렉스튜디오 가견적 계산기</title>
  <script src="https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    body {font-family: Pretendard, sans-serif; max-width: 820px; margin: 20px auto; padding: 20px; line-height: 1.6; color: #333;}
    h2 {border-bottom: 2px solid #ccc; padding-bottom: 5px;}
    label {display: block; margin: 8px 0 4px;}
    select, input[type=number] {width: 100%; padding: 6px; margin-bottom: 10px; box-sizing: border-box;}
    .row {display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
    .row > div {flex: 1; min-width: 46%;}
    button {background: #222; color: #fff; border: none; padding: 8px 14px; cursor: pointer; margin-top: 6px;}
    .result {white-space: pre-line; margin-top: 20px; font-size: 1.1em; font-weight: 600;}
    .group-box {margin-bottom: 28px; padding: 14px; border: 2px solid #aaa; border-radius: 8px; background: #f0f4f8;}
    .license-group {background: #f9f9f9; border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 18px;}
    .license-group .row div {min-width: 45%;}
    .task-remove {float: right; background: #f55; border-radius: 4px; padding: 2px 6px; font-size: .85em; margin-top: -8px; color: #fff;}
  </style>
</head>
<body>
<h2>플렉스튜디오 가견적 계산기</h2>
<div class="group-box">
  <h3>1️⃣ 구축 견적 계산</h3>
  <div id="taskContainer"></div>
  <button onclick="addTaskBlock()">업무 항목 추가하기</button>
</div>
<div class="group-box">
  <h3>2️⃣ 라이선스 유형 선택</h3>
  <div class="license-group">
    <label><input type="radio" name="licenseType" value="subscription" checked onclick="toggleLicense('subscription')"> 구독형</label>
    <label><input type="radio" name="licenseType" value="fixed" onclick="toggleLicense('fixed')"> 구축형</label>
  </div>
  <div id="subscriptionLicense" class="license-group">
    <h4>📄 구독형 라이선스 입력</h4>
    <div class="row">
      <div><label>개발자 수:</label><input type="number" id="developerCount" value="1" min="1"></div>
      <div><label>내부 사용자 수:</label><input type="number" id="internalUsers" value="50" min="50"></div>
    </div>
    <div class="row">
      <div><label>시스템 연동 수 (ERP, DB 등):</label><input type="number" id="integrationCount" value="1" min="1"></div>
      <div><label>연 단위 할인율(%):</label><input type="number" id="discountRate" value="10"></div>
    </div>
    <div class="row">
      <div>
        <label>라이선스 결제 주기:</label>
        <select id="billingCycle"><option value="1">월</option><option value="12">연(12개월)</option></select>
      </div>
      <div>
        <label>보안사항 (월 450,000)</label>
        <label><input type="checkbox" class="licenseOption" value="450000"> Azure AD SSO</label>
        <label><input type="checkbox" class="licenseOption" value="450000"> AWS VPN</label>
      </div>
    </div>
  </div>
  <div id="fixedLicense" class="license-group" style="display:none">
    <h4>🏗️ 구축형 라이선스 입력</h4>
    <p><strong>기본 포함:</strong> 워크스페이스, 개발자 3명, FSK, 내부 사용자 500명</p>
    <div class="row">
      <div><label>추가 개발자 수:</label><input type="number" id="fixedDevCount" value="0"></div>
      <div><label>추가 내부 사용자 수:</label><input type="number" id="fixedUserCount" value="0"></div>
      <div><label>대용량 추가 사용자 수:</label><input type="number" id="bulkUserCount" value="0"></div>
    </div>
  </div>
</div>
<button onclick="calculateEstimate()">💰 가견적 계산하기</button>
<button id="downloadBtn" onclick="exportExcel()" disabled>📥 엑셀 다운로드</button>
<div class="result" id="result"></div>
<script>
function toggleLicense(t){
  subscriptionLicense.style.display = t==='subscription' ? 'block' : 'none';
  fixedLicense.style.display = t==='fixed' ? 'block' : 'none';
}
function addTaskBlock(){
  const c=document.getElementById('taskContainer');
  const b=document.createElement('div');
  b.className='group-box';
  b.innerHTML=`<button class="task-remove" onclick="this.parentNode.remove()">삭제</button>
  <label>업무 유형:</label><select class="taskType">
    <option>거래 프로세스형</option><option>문서 처리형</option><option>자산/설비 관리형</option>
    <option>사용자 요청형</option><option>분석/리포트형</option></select>
  <label>주요 화면 복잡도:</label><select class="screenGrade">
    <option value="1.0">S-단순 조회형</option>
    <option value="1.5">A-입력/승인형</option>
    <option value="2.0">B-복합 조건형</option></select>
  <label>기능 옵션:</label>
    <label><input type="checkbox" value="0.5"> 시스템 연동</label>
    <label><input type="checkbox" value="0.3"> 승인 프로세스</label>
    <label><input type="checkbox" value="0.5"> 모바일 대응</label>
    <label><input type="checkbox" value="0.3"> Excel 업/다운</label>`;
  c.appendChild(b);
}
let lastSheets=null;
function calculateEstimate(){
  let tasks=[]; let totalMM=0;
  document.querySelectorAll('#taskContainer .group-box').forEach((b,i)=>{
    const type=b.querySelector('.taskType').value;
    const screen=parseFloat(b.querySelector('.screenGrade').value);
    let opt=0;
    b.querySelectorAll('input[type=checkbox]:checked').forEach(o=>opt+=parseFloat(o.value));
    const mm=screen+opt;
    totalMM+=mm;
    tasks.push({No:i+1,업무유형:type,화면등급:(screen).toFixed(1),옵션MM:opt.toFixed(1),총MM:mm.toFixed(1)});
  });
  const licenseType=document.querySelector('input[name=licenseType]:checked').value;
  let licenseInfo={유형:licenseType};
  if(licenseType==='subscription'){
    let dev=Math.max(1,+developerCount.value);
    let intg=Math.max(1,+integrationCount.value);
    let usr=Math.max(50,+internalUsers.value);
    developerCount.value=dev;
    integrationCount.value=intg;
    internalUsers.value=usr;
    const sec=[...document.querySelectorAll('.licenseOption:checked')].length*450000;
    const bill=+billingCycle.value;
    const disc=+discountRate.value;
    base=(dev*150000+intg*100000+usr*10000+sec);
    let lic=base*bill;
    if(bill===12)lic*=1-disc/100;
    licenseInfo={유형:'구독형',개발자수:dev,시스템연동:intg,사용자:usr,보안비용:sec,결제주기:bill===1?'월':'연',할인율:`${disc}%`,라이선스비용:lic};
  } else {
    const addDev=+fixedDevCount.value,addUsr=+fixedUserCount.value,bulk=+bulkUserCount.value,fixed=30000000+addDev*1500000+addUsr*100000+bulk*50000;
    const m=fixed*0.15;
    licenseInfo={유형:'구축형',추가Dev:addDev,추가User:addUsr,bulkUser:bulk,기본비용:fixed,유지보수:m};
  }
  lastSheets={tasks,licenseInfo,totalMM};
  document.getElementById('result').innerText=`총 개발 공수: ${totalMM.toFixed(1)} MM\n라이선스 유형: ${licenseInfo.유형}`;
  document.getElementById('downloadBtn').disabled = false;
}
function exportExcel(){
  if(!lastSheets){alert('먼저 가견적을 계산하세요');return;}
  if(typeof XLSX==='undefined'){
    alert('XLSX 라이브러리를 불러오지 못했습니다. CSV로 대신 저장합니다.');
    return exportCSV();
  }
  try {
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(lastSheets.tasks),'공수');
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet([lastSheets.licenseInfo]),'라이선스');
    XLSX.writeFile(wb,'Flextudio_Estimate.xlsx');
  } catch(e){
    console.error('엑셀 저장 중 오류 발생:', e);
    alert('엑셀 저장 중 오류가 발생했습니다. 콘솔 확인 후 개발자에게 문의하세요.');
  }
}
function exportCSV(){
  const rows=[['공수 시트']];
  rows.push(Object.keys(lastSheets.tasks[0]));
  lastSheets.tasks.forEach(r=>rows.push(Object.values(r)));
  rows.push([]);
  rows.push(['라이선스 시트']);
  rows.push(Object.keys(lastSheets.licenseInfo));
  rows.push(Object.values(lastSheets.licenseInfo));
  let csv=rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='Flextudio_Estimate.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
}
</script>
</body>
</html>
